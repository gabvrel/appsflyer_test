<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppsFlyer PBA + GTM Event Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .code-block { font-family: 'Fira Code', monospace; }
        /* Animation for new log entries */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-entry { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-lucide="activity" class="h-6 w-6 text-green-400"></i>
                <h1 class="text-xl font-bold">AppsFlyer PBA / GTM Tester</h1>
            </div>
            <div class="text-sm text-blue-200">
                Web SDK Integration Helper
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-6">
        
        <!-- LEFT COLUMN: Controls & Simulator -->
        <div class="w-full lg:w-1/2 space-y-6">
            
            <!-- Step 1: Configuration -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="bg-blue-100 p-2 rounded-lg">
                        <i data-lucide="settings" class="h-5 w-5 text-blue-600"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-800">1. GTM Configuration</h2>
                </div>
                
                <div class="space-y-4">
                    <p class="text-sm text-gray-600">
                        Enter your GTM Container ID to load your actual tag configuration into this test environment.
                    </p>
                    <div class="flex gap-2">
                        <input type="text" id="gtmIdInput" placeholder="GTM-XXXXXX" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none uppercase font-mono">
                        <button onclick="injectGTM()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                            <i data-lucide="play" class="h-4 w-4"></i> Load GTM
                        </button>
                    </div>
                    <div id="gtmStatus" class="hidden text-sm flex items-center gap-2 p-3 rounded bg-gray-50 text-gray-600">
                        <!-- Status injected here -->
                    </div>
                </div>
            </div>

            <!-- Step 2: Event Simulator -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="bg-purple-100 p-2 rounded-lg">
                        <i data-lucide="shopping-cart" class="h-5 w-5 text-purple-600"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-800">2. Event Simulator</h2>
                </div>

                <div class="space-y-6">
                    <p class="text-sm text-gray-600 mb-4">
                        Click these buttons to push raw event data to the <code>dataLayer</code>. Verify these trigger your AppsFlyer tags in GTM.
                    </p>

                    <!-- Event: View Content -->
                    <div class="border rounded-lg p-4 hover:border-purple-300 transition-colors bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-700">View Content</span>
                            <span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded text-gray-600">af_view_content</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">Simulates viewing a product page.</p>
                        <button onclick="pushEvent('view_content')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg shadow-sm transition-all flex justify-center items-center gap-2">
                            <i data-lucide="eye" class="h-4 w-4"></i> Trigger Event
                        </button>
                    </div>

                    <!-- Event: Add to Cart -->
                    <div class="border rounded-lg p-4 hover:border-purple-300 transition-colors bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-700">Add To Cart</span>
                            <span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded text-gray-600">af_add_to_cart</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">Simulates adding an item to the basket.</p>
                        <button onclick="pushEvent('add_to_cart')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg shadow-sm transition-all flex justify-center items-center gap-2">
                            <i data-lucide="shopping-bag" class="h-4 w-4"></i> Trigger Event
                        </button>
                    </div>

                    <!-- Event: Purchase -->
                    <div class="border rounded-lg p-4 hover:border-purple-300 transition-colors bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-700">Purchase</span>
                            <span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded text-gray-600">af_purchase</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">Simulates a completed transaction.</p>
                        <button onclick="pushEvent('purchase')" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition-all flex justify-center items-center gap-2">
                            <i data-lucide="credit-card" class="h-4 w-4"></i> Trigger Event
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Inspector & Docs -->
        <div class="w-full lg:w-1/2 space-y-6">
            
            <!-- Data Layer Inspector -->
            <div class="bg-gray-900 rounded-xl shadow-lg border border-gray-700 overflow-hidden flex flex-col h-[600px]">
                <div class="p-4 border-b border-gray-700 bg-gray-800 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-white">
                        <i data-lucide="terminal" class="h-4 w-4 text-green-400"></i>
                        <h2 class="font-mono text-sm font-bold">Data Layer Inspector</h2>
                    </div>
                    <button onclick="clearLogs()" class="text-xs text-gray-400 hover:text-white underline">Clear</button>
                </div>
                
                <div id="consoleOutput" class="flex-1 overflow-y-auto p-4 space-y-4 font-mono text-sm">
                    <div class="text-gray-500 italic text-center mt-10">Waiting for events...</div>
                </div>
            </div>

            <!-- Mini Guide -->
            <div class="bg-blue-50 rounded-xl p-6 border border-blue-100">
                <h3 class="font-semibold text-blue-900 mb-2 flex items-center gap-2">
                    <i data-lucide="info" class="h-4 w-4"></i>
                    GTM Setup Tip
                </h3>
                <p class="text-sm text-blue-800 mb-3">
                    In Google Tag Manager, create a <strong>Custom Event Trigger</strong> for each event name listed above (e.g., <code>af_add_to_cart</code>).
                </p>
                <p class="text-sm text-blue-800">
                    Map the Data Layer Variables (shown in the black console) to your AppsFlyer Tag parameters (e.g., map <code>af_revenue</code> to the Revenue field).
                </p>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-6 mt-auto">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            AppsFlyer PBA Testing Utility &bull; Not affiliated with AppsFlyer
        </div>
    </footer>

    <script>
        // Initialize Lucide icons safely
        document.addEventListener("DOMContentLoaded", () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        // 1. Initialize Data Layer if not present
        window.dataLayer = window.dataLayer || [];

        // Log initial state
        logToConsole({ info: "Tool initialized. Waiting for GTM..." });

        function injectGTM() {
            const gtmId = document.getElementById('gtmIdInput').value.trim();
            const statusDiv = document.getElementById('gtmStatus');

            if (!gtmId.startsWith('GTM-')) {
                alert('Please enter a valid GTM ID (e.g., GTM-XXXXXX)');
                return;
            }

            // Visual feedback
            statusDiv.classList.remove('hidden');
            statusDiv.classList.remove('bg-red-50', 'text-red-600');
            statusDiv.classList.add('bg-green-50', 'text-green-700');
            statusDiv.innerHTML = `<i data-lucide="check-circle" class="h-4 w-4"></i> <span>Injecting container <strong>${gtmId}</strong>... Check your browser extensions.</span>`;
            
            // Refresh icons for new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Actual GTM Injection Logic
            (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer', gtmId);

            logToConsole({ system: `GTM Container ${gtmId} injected.` });
        }

        // Event Definitions based on AppsFlyer PBA Standards
        // Reference: Common mappings for AF events
        const eventTemplates = {
            view_content: {
                event: 'af_view_content',
                af_content_type: 'product',
                af_content_id: '12345',
                af_content_name: 'Premium Wireless Headphones',
                af_currency: 'USD',
                af_price: 199.99
            },
            add_to_cart: {
                event: 'af_add_to_cart',
                af_content_type: 'product',
                af_content_id: '12345',
                af_quantity: 1,
                af_currency: 'USD',
                af_price: 199.99,
                af_revenue: 199.99 // Sometimes AF expects revenue on add to cart depending on config
            },
            purchase: {
                event: 'af_purchase',
                af_content_type: 'product',
                af_content_id: '12345',
                af_order_id: 'ORDER_' + Math.floor(Math.random() * 100000),
                af_currency: 'USD',
                af_revenue: 199.99,
                af_quantity: 1
            }
        };

        function pushEvent(type) {
            const eventData = eventTemplates[type];
            
            // Push to GTM Data Layer
            window.dataLayer.push(eventData);

            // Log to our visual inspector
            logToConsole(eventData);
            
            // Visual feedback on button
            // (Optional: add a toast or flash effect)
        }

        function logToConsole(data) {
            const consoleOutput = document.getElementById('consoleOutput');
            const entry = document.createElement('div');
            entry.className = 'log-entry bg-gray-800 p-3 rounded border border-gray-700 text-green-300';
            
            // Format timestamp
            const time = new Date().toLocaleTimeString();
            
            // Check if it's a system message or data object
            if (data.info || data.system) {
                entry.className = 'log-entry bg-gray-800 p-2 rounded text-gray-500 text-xs border-l-2 border-blue-500';
                entry.innerText = `[${time}] ${data.info || data.system}`;
            } else {
                // Formatting JSON nicely
                const eventName = data.event ? `<span class="text-white font-bold">${data.event}</span>` : 'Data Push';
                
                let jsonHtml = '';
                for (const [key, value] of Object.entries(data)) {
                    if (key === 'event') continue;
                    jsonHtml += `<div class="ml-4"><span class="text-blue-300">${key}:</span> <span class="text-yellow-200">${value}</span></div>`;
                }

                entry.innerHTML = `
                    <div class="flex justify-between text-gray-400 text-xs mb-1">
                        <span>dataLayer.push({</span>
                        <span>${time}</span>
                    </div>
                    <div class="ml-4 mb-1">event: ${eventName},</div>
                    ${jsonHtml}
                    <div class="text-gray-400 text-xs">});</div>
                `;
            }

            // Remove empty state message if exists
            if (consoleOutput.children[0] && consoleOutput.children[0].innerText === "Waiting for events...") {
                consoleOutput.innerHTML = '';
            }

            consoleOutput.prepend(entry);
        }

        function clearLogs() {
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML = '<div class="text-gray-500 italic text-center mt-10">Logs cleared.</div>';
        }

    </script>
</body>
</html>