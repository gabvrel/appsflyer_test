<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppsFlyer Direct SDK Tester (No GTM)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .code-block { font-family: 'Fira Code', monospace; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-entry { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-lucide="zap" class="h-6 w-6 text-yellow-400"></i>
                <h1 class="text-xl font-bold">AppsFlyer Direct SDK Tester</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-indigo-200 hidden md:inline">Direct Integration (No GTM)</span>
                <a href="appsflyer_tester.html" class="bg-indigo-800 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-md text-xs font-medium border border-indigo-600 transition-colors flex items-center gap-2">
                    Go to GTM Version <i data-lucide="arrow-right" class="h-3 w-3"></i>
                </a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-6">
        
        <!-- LEFT COLUMN: Controls -->
        <div class="w-full lg:w-1/2 space-y-6">
            
            <!-- Step 1: SDK Configuration -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="bg-indigo-100 p-2 rounded-lg">
                        <i data-lucide="settings" class="h-5 w-5 text-indigo-600"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-800">1. SDK Configuration</h2>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Web Dev Key (GUID)</label>
                        <input type="text" id="afDevKey" placeholder="e.g. a1b2c3d4-e5f6-..." 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono text-sm">
                        <p class="text-xs text-gray-400 mt-1">Found in AppsFlyer > My Apps > View brand bundles</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Brand Bundle ID</label>
                        <input type="text" id="afBrandId" placeholder="e.g. com.myshop.web" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono text-sm">
                    </div>

                    <button onclick="initDirectSDK()" 
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex justify-center items-center gap-2">
                        <i data-lucide="power" class="h-4 w-4"></i> Initialize SDK
                    </button>
                    
                    <div id="sdkStatus" class="hidden text-sm flex items-center gap-2 p-3 rounded bg-gray-50 text-gray-600"></div>
                </div>
            </div>

            <!-- Step 2: User Identity (Crucial for PBA) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 opacity-50 pointer-events-none transition-all" id="step2Panel">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="bg-blue-100 p-2 rounded-lg">
                        <i data-lucide="user" class="h-5 w-5 text-blue-600"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-800">2. Identity (Recommended)</h2>
                </div>
                <p class="text-xs text-gray-500 mb-3">PBA works best when events are linked to a Customer User ID (CUID).</p>
                <div class="flex gap-2">
                    <button onclick="setRandomCUID()" class="flex-1 bg-blue-50 border border-blue-200 text-blue-700 py-2 px-3 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">
                        Set Random CUID
                    </button>
                </div>
                <div id="cuidDisplay" class="text-xs font-mono text-gray-500 mt-2 text-center hidden"></div>
            </div>

            <!-- Step 3: Event Simulator -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 opacity-50 pointer-events-none transition-all" id="step3Panel">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="bg-pink-100 p-2 rounded-lg">
                        <i data-lucide="mouse-pointer" class="h-5 w-5 text-pink-600"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-800">3. Standard Conversion Events</h2>
                </div>

                <div class="space-y-4">
                    <p class="text-sm text-gray-600 mb-4">
                        These use the standard <code>af_</code> event names to ensure dashboard recognition.
                    </p>

                    <!-- Event: View Content -->
                    <button onclick="sendDirectEvent('view_content')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-3 px-4 rounded-lg shadow-sm transition-all flex justify-between items-center group">
                        <span class="font-medium">View Content</span>
                        <code class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 group-hover:bg-gray-200">af_view_content</code>
                    </button>

                    <!-- Event: Add to Cart -->
                    <button onclick="sendDirectEvent('add_to_cart')" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-3 px-4 rounded-lg shadow-sm transition-all flex justify-between items-center group">
                        <span class="font-medium">Add To Cart</span>
                        <code class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 group-hover:bg-gray-200">af_add_to_cart</code>
                    </button>

                    <!-- Event: Purchase -->
                    <button onclick="sendDirectEvent('purchase')" class="w-full bg-green-50 border border-green-200 hover:bg-green-100 text-green-800 py-3 px-4 rounded-lg shadow-sm transition-all flex justify-between items-center group">
                        <div class="flex flex-col items-start">
                            <span class="font-medium flex items-center gap-2"><i data-lucide="credit-card" class="h-4 w-4"></i> Purchase</span>
                            <span class="text-[10px] text-green-600/70 ml-6">Standard Conversion</span>
                        </div>
                        <code class="text-xs bg-white/50 px-2 py-1 rounded text-green-700 group-hover:bg-white/80">af_purchase</code>
                    </button>

                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: SDK Logger -->
        <div class="w-full lg:w-1/2 space-y-6">
            
            <div class="bg-gray-900 rounded-xl shadow-lg border border-gray-700 overflow-hidden flex flex-col h-[600px]">
                <div class="p-4 border-b border-gray-700 bg-gray-800 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-white">
                        <i data-lucide="terminal" class="h-4 w-4 text-yellow-400"></i>
                        <h2 class="font-mono text-sm font-bold">SDK Operation Log</h2>
                    </div>
                    <div class="flex gap-3">
                        <span class="text-xs text-gray-400 flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-red-500" id="connectionDot"></span>
                            <span id="connectionText">Not Loaded</span>
                        </span>
                        <button onclick="clearLogs()" class="text-xs text-gray-400 hover:text-white underline">Clear</button>
                    </div>
                </div>
                
                <div id="consoleOutput" class="flex-1 overflow-y-auto p-4 space-y-4 font-mono text-sm">
                    <div class="text-gray-500 italic text-center mt-10">Initialize SDK to start...</div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Initialize Icons
        document.addEventListener("DOMContentLoaded", () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });

        let isSdkInitialized = false;

        function initDirectSDK() {
            const devKey = document.getElementById('afDevKey').value.trim();
            const brandId = document.getElementById('afBrandId').value.trim();
            const statusDiv = document.getElementById('sdkStatus');
            const step2 = document.getElementById('step2Panel');
            const step3 = document.getElementById('step3Panel');

            if (!devKey || !brandId) {
                alert('Please enter both Web Dev Key and Brand Bundle ID');
                return;
            }

            // --- AppsFlyer SDK Snippet (Modified for Dynamic Injection) ---
            !function(t,e,n,s,a,c,i,o,p){t.AppsFlyerSdkObject=a,t.AF=t.AF||function(){
            (t.AF.q=t.AF.q||[]).push([Date.now()].concat(Array.prototype.slice.call(arguments)))},
            t.AF.id=t.AF.id||i,t.AF.plugins={},o=e.createElement(n),p=e.getElementsByTagName(n)[0],o.async=1,
            o.src="https://websdk.appsflyer.com?"+(c.length>0?"st="+c.split(",").sort().join(",")+"&":"")+(i.length>0?"af_id="+i:""),
            p.parentNode.insertBefore(o,p)}(window,document,"script",0,"AF","pba",{pba: {webAppId: devKey}});

            isSdkInitialized = true;

            // UI Feedback
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = `<i data-lucide="check" class="h-4 w-4 text-green-600"></i> SDK Script Injected`;
            lucide.createIcons();

            document.getElementById('connectionDot').className = "w-2 h-2 rounded-full bg-green-500";
            document.getElementById('connectionText').innerText = "SDK Active";
            
            // Enable panels
            step2.classList.remove('opacity-50', 'pointer-events-none');
            step3.classList.remove('opacity-50', 'pointer-events-none');

            logToConsole({ 
                type: 'function', 
                name: 'AF("pba", "start", ...)', 
                details: `Initializing with Key: ${devKey}` 
            });
        }

        function setRandomCUID() {
            const cuid = 'USER_' + Math.floor(Math.random() * 1000000);
            
            if (window.AF) {
                // The correct API for CUID in PBA Web SDK is setCustomerUserId
                window.AF('pba', 'setCustomerUserId', cuid);
                
                logToConsole({
                    type: 'function',
                    name: 'AF("pba", "setCustomerUserId", ...)',
                    details: `CUID set to: ${cuid}`
                });

                const display = document.getElementById('cuidDisplay');
                display.innerText = `Current CUID: ${cuid}`;
                display.classList.remove('hidden');
            }
        }

        // Updated Templates with af_ prefixes and strictly typed values
        const eventDataTemplates = {
            view_content: {
                eventName: 'af_view_content', // Changed from view_content
                eventValue: {
                    af_content_type: 'product',
                    af_content_id: '12345',
                    af_price: 199.99,
                    af_currency: 'USD'
                }
            },
            add_to_cart: {
                eventName: 'af_add_to_cart', // Changed from add_to_cart
                eventValue: {
                    af_content_type: 'product',
                    af_content_id: '12345',
                    af_price: 199.99,
                    af_currency: 'USD',
                    af_quantity: 1
                }
            },
            purchase: {
                eventName: 'af_purchase', // Changed from purchase
                eventValue: {
                    af_content_type: 'product',
                    af_content_id: '12345',
                    af_revenue: 199.99, // Number (Critical)
                    af_currency: 'USD', // String (Critical)
                    af_order_id: 'ORD-' + Math.floor(Math.random() * 999999),
                    af_quantity: 1
                }
            }
        };

        function sendDirectEvent(type) {
            if (!isSdkInitialized) {
                alert("Please Initialize SDK first!");
                return;
            }

            const data = eventDataTemplates[type];
            
            if (window.AF) {
                window.AF('pba', 'event', {
                    eventType: 'EVENT',
                    eventName: data.eventName,
                    eventValue: data.eventValue
                });

                logToConsole({
                    type: 'call',
                    name: `AF('pba', 'event', ...)`,
                    payload: {
                        eventType: 'EVENT',
                        eventName: data.eventName,
                        eventValue: data.eventValue
                    }
                });
            } else {
                logToConsole({ type: 'error', msg: 'window.AF is undefined. Script blocked?' });
            }
        }

        function logToConsole(data) {
            const consoleOutput = document.getElementById('consoleOutput');
            const entry = document.createElement('div');
            entry.className = 'log-entry bg-gray-800 p-3 rounded border border-gray-700 font-mono text-xs';
            
            const time = new Date().toLocaleTimeString();

            if (data.type === 'error') {
                entry.classList.add('border-red-500', 'text-red-300');
                entry.innerHTML = `[${time}] <strong>ERROR:</strong> ${data.msg}`;
            } else if (data.type === 'function') {
                entry.classList.add('text-blue-300');
                entry.innerHTML = `[${time}] <strong>${data.name}</strong><br><span class="text-gray-400">${data.details}</span>`;
            } else {
                // Event Call
                entry.classList.add('text-green-300');
                const jsonHtml = JSON.stringify(data.payload, null, 2)
                    .replace(/"([^"]+)":/g, '<span class="text-blue-300">"$1":</span>')
                    .replace(/: "([^"]+)"/g, ': <span class="text-yellow-200">"$1"</span>')
                    .replace(/: ([0-9\.]+)/g, ': <span class="text-pink-400">$1</span>'); // Highlight numbers

                entry.innerHTML = `
                    <div class="flex justify-between text-gray-400 mb-1">
                        <span class="font-bold text-white">SDK Call Fired</span>
                        <span>${time}</span>
                    </div>
                    <div class="whitespace-pre-wrap">${jsonHtml}</div>
                `;
            }

            if (consoleOutput.children[0] && consoleOutput.children[0].innerText.includes("Initialize SDK")) {
                consoleOutput.innerHTML = '';
            }
            consoleOutput.prepend(entry);
        }

        function clearLogs() {
            document.getElementById('consoleOutput').innerHTML = '<div class="text-gray-500 italic text-center mt-10">Logs cleared.</div>';
        }
    </script>
</body>
</html>